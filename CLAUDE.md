# CLAUDE.md

このファイルは、Claude Codeがこのプロジェクトの実装を支援するためのコンテキスト情報を提供します。

---

## プロジェクト概要

**プロジェクト名**: Webページリマインダー Chrome拡張機能

**目的**: 特定のWebページにアクセスした際に、事前に登録したリマインダー（やるべきこと）を表示するChrome拡張機能を開発する。

**主要な技術スタック**:
- Chrome Extensions Manifest V3
- JavaScript (Vanilla)
- HTML/CSS
- chrome.storage.local API
- Content Scripts

---

## プロジェクト構造

```
extension/
├── manifest.json          # Manifest V3設定ファイル
├── popup.html            # 拡張機能ポップアップのHTML
├── popup.js              # ポップアップのロジック（登録・管理機能）
├── popup.css             # ポップアップのスタイル
├── content.js            # Webページへのリマインダー表示ロジック
├── content.css           # リマインダーポップアップのスタイル
└── icons/                # 拡張機能アイコン
    ├── icon16.png
    ├── icon48.png
    └── icon128.png
```

---

## 主要機能の実装ポイント

### 1. URL照合ルール
- **マッチング方式**: リマインダーごとに選択可能
  - **ドメイン一致**（デフォルト）: 登録URLと現在のURLのドメイン（プロトコル + ホスト名）を比較
    - 例: `https://example.com` を登録 → `https://example.com/any/path` でマッチ
  - **前方一致**: 登録URLで始まるすべてのページでマッチ
    - 例: `https://example.com/shop` を登録 → `https://example.com/shop/products` でマッチ
  - **完全一致**: 登録URLと完全に一致するページのみマッチ
    - 例: `https://example.com/page` を登録 → `https://example.com/page` のみマッチ
- 同一URL・同一ドメインへの複数登録を許可

### 2. リマインダー表示 (content.js)
- **表示タイミング**: ページ読み込み完了時 (`DOMContentLoaded` または `load` イベント)
- **表示方法**: 画面右上に固定表示される非ブロッキングポップアップ
- **複数リマインダー**: 1つのポップアップ内にリスト表示
- **非ブロッキング設計**: リマインダー表示中もWebページの操作が可能

#### UIコンポーネント
- 画面右上に固定表示（400px幅）
- 背景オーバーレイなし（ページを暗くしない）
- `pointer-events: none` でクリックを透過、ポップアップ本体のみ操作可能
- スクロール可能なリスト
- 各リマインダーに「完了」ボタン
- 「すべて閉じる」ボタン

#### 操作フロー
- **個別削除（完了）**: 特定のリマインダーをストレージから削除し、リストから即座に消える
- **すべて閉じる**: ポップアップのみ非表示、リマインダーはストレージに残る

### 3. リマインダー登録機能 (popup.js)
- 現在表示中のページのドメインを自動入力（`chrome.tabs.query` APIを使用）
- URL照合方式の選択（ラジオボタン）
  - ドメイン一致（デフォルト）
  - 前方一致
  - 完全一致
- URLとテキストのバリデーション（空チェック）
- UUID生成（リマインダーID用）
- `chrome.storage.local` への保存

### 4. リマインダー管理機能 (popup.js)
- URL別にグループ化して一覧表示
- 各リマインダーにマッチング方式のバッジ表示
- 削除機能（管理画面からの削除）
- リマインダーが0件の場合のメッセージ表示
- 既存リマインダーの自動マイグレーション（matchTypeフィールド追加）

---

## データ構造

### chrome.storage.local のスキーマ

```javascript
{
  reminders: [
    {
      id: "uuid_1",                          // ユニークID
      url: "https://example.com",            // 照合用URL
      text: "クーポンコードを入力すること",    // リマインダーテキスト
      matchType: "domain",                   // 照合方式: "domain" | "prefix" | "exact"
      createdAt: "2025-10-31T10:00:00Z"     // 作成日時（ISO 8601形式）
    },
    // ...
  ]
}
```

---

## 重要な実装考慮事項

### バリデーション
- URLが空の場合: 登録ボタンを無効化
- テキストが空の場合: 登録ボタンを無効化
- 重複登録は許可（意図的に複数回登録する場合を考慮）

### 表示関連
- 高いz-index設定（既存コンテンツに被らないように）
- 画面右上に固定配置（`top: 20px; right: 20px;`）
- 非ブロッキング設計（`pointer-events: none` でページ操作を妨げない）
- リマインダーが多い場合のスクロール対応
- レスポンシブデザイン考慮

### 削除・完了の挙動
- 個別完了: 該当リマインダーのみ削除、他は残る
- 全完了: ポップアップを自動的に閉じる
- 「すべて閉じる」: ポップアップのみ非表示、次回再表示

### 再表示ルール
- ページ更新（F5）→ 再表示
- 別ページから戻る → 再表示
- ブラウザ再起動後 → 再表示
- 「完了」で削除されるまで何度でも表示

---

## Manifest V3 の必須設定

```json
{
  "manifest_version": 3,
  "permissions": [
    "storage",
    "activeTab"
  ],
  "content_scripts": [
    {
      "matches": ["<all_urls>"],
      "js": ["content.js"],
      "css": ["content.css"]
    }
  ],
  "action": {
    "default_popup": "popup.html"
  }
}
```

---

## 開発フロー

### 1. 登録フロー
1. ユーザーが拡張機能アイコンをクリック
2. 現在のページのドメインが自動入力される
3. URL照合方式を選択（ドメイン一致、前方一致、完全一致）
4. リマインダー内容を入力
5. 「登録」ボタンをクリック
6. `chrome.storage.local` に保存
7. 成功メッセージ表示

### 2. 表示・操作フロー
1. ユーザーがWebページにアクセス
2. `content.js` がページ読み込み完了を検知
3. 各リマインダーの`matchType`に応じてURL照合を実行
   - `domain`: ドメイン一致
   - `prefix`: 前方一致
   - `exact`: 完全一致
4. 該当リマインダーを全て取得
5. 画面右上にポップアップを生成して表示
6. **ページ操作は継続可能**（非ブロッキング）
7. ユーザー操作（完了 or すべて閉じる）

### 3. 管理フロー
1. 拡張機能アイコンをクリック
2. 登録済みリマインダー一覧を表示（URL別グループ化）
3. 削除ボタンで個別削除
4. 一覧を更新

---

## 将来の拡張可能性（現バージョンでは未実装）

- カテゴリやタグでの分類
- 優先度設定
- 表示回数制限
- エクスポート/インポート機能
- スヌーズ機能
- 正規表現対応の追加
- サブドメイン対応オプション
- `chrome.storage.sync` による複数デバイス同期

---

## 実装時の注意点

### セキュリティ
- コンテンツスクリプトでのDOM操作時、XSS対策を考慮
- ユーザー入力のサニタイズ（特にリマインダーテキスト表示時）

### パフォーマンス
- ストレージアクセスは非同期処理
- 大量のリマインダー登録時のパフォーマンス考慮

### ユーザビリティ
- 直感的なUI/UX
- 適切なフィードバックメッセージ
- エラーハンドリング

---

## テスト観点

1. **URL照合テスト**
   - ドメイン一致が正しく機能するか
   - 前方一致が正しく機能するか
   - 完全一致が正しく機能するか
   - 異なるmatchTypeが混在する場合も正しく動作するか
   - サブドメインは別ドメインとして扱われるか（ドメイン一致の場合）
   - 複数リマインダーが正しく表示されるか

2. **CRUD操作テスト**
   - 登録、表示、削除が正しく動作するか
   - ストレージとの同期が正しく行われるか

3. **UI/UX テスト**
   - ポップアップが画面右上に適切に表示されるか
   - リマインダー表示中もページ操作が可能か（非ブロッキング）
   - 「完了」と「すべて閉じる」の挙動が正しいか
   - レスポンシブ対応

4. **エッジケーステスト**
   - リマインダーが0件の場合
   - リマインダーが大量にある場合
   - 長いURL/テキストの場合

---

## 参考情報

- [Chrome Extensions Manifest V3](https://developer.chrome.com/docs/extensions/mv3/)
- [chrome.storage API](https://developer.chrome.com/docs/extensions/reference/storage/)
- [Content Scripts](https://developer.chrome.com/docs/extensions/mv3/content_scripts/)

---

**最終更新**: 2025年10月31日
